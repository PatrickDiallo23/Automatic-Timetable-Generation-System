<div class="timetable-container">
  <mat-card class="header-card" elevation="3">
    <mat-card-header>
      <div mat-card-avatar class="header-avatar">
        <mat-icon>schedule</mat-icon>
      </div>
      <mat-card-title class="page-title">Timetable Management Overview</mat-card-title>
      <mat-card-subtitle *ngIf="isAdmin(user)" class="page-subtitle">
        View and manage academic schedules
      </mat-card-subtitle>
      <mat-card-subtitle *ngIf="!isAdmin(user)" class="page-subtitle">
        View academic schedule
      </mat-card-subtitle>
    </mat-card-header>

    <!-- Score Display with Visual Indicators -->
    <mat-card-content class="score-section" *ngIf="isAdmin(user) && score !== null">
      <div class="score-display">
        <div class="score-item">
          <mat-icon class="score-icon uninitialized">pending</mat-icon>
          <span class="score-label">Init Score</span>
          <span class="score-value uninitialized">{{score?.initScore}}</span>
        </div>
        <div class="score-item">
          <mat-icon class="score-icon hard">error</mat-icon>
          <span class="score-label">Hard Score</span>
          <span class="score-value hard">{{score?.hardScore}}</span>
        </div>
        <div class="score-item">
          <mat-icon class="score-icon medium">warning</mat-icon>
          <span class="score-label">Medium Score</span>
          <span class="score-value medium">{{score?.mediumScore}}</span>
        </div>
        <div class="score-item">
          <mat-icon class="score-icon soft">info</mat-icon>
          <span class="score-label">Soft Score</span>
          <span class="score-value soft">{{score?.softScore}}</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="filter-card" elevation="2">
    <mat-card-header>
      <mat-card-title class="filter-title">
        <mat-icon>filter_list</mat-icon>
        Filter Options
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <!-- Toggle Buttons for View Type -->
      <div class="view-toggle-section">
        <mat-button-toggle-group
          [value]="toggle"
          (change)="toogle($event.value)"
          class="view-toggle">
          <mat-button-toggle value="student" class="toggle-option">
            <mat-icon>groups</mat-icon>
            Student View
          </mat-button-toggle>
          <mat-button-toggle value="teacher" class="toggle-option">
            <mat-icon>person</mat-icon>
            Teacher View
          </mat-button-toggle>
        </mat-button-toggle-group>
      </div>

      <!-- Student Filter Section -->
      <div *ngIf="toggle == 'student'" class="filter-section">
        <div class="filter-row">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Student Group</mat-label>
            <mat-icon matPrefix>groups</mat-icon>
            <div [formGroup]="studentGroupFormGroup">
              <input
                type="text"
                placeholder="e.g., 313 AA"
                #studentGroup
                matInput
                formControlName="studentGroupControl"
                [matAutocomplete]="autoStudent"
                (focus)="selectInput($event)">
            </div>
            <mat-autocomplete #autoStudent="matAutocomplete"
                              (optionSelected)="filterTimetable(studentGroup.value, studentGroupSemiGroup.value)">
              <mat-option *ngFor="let group of filteredStudentGroups | async" [value]="group">
                <mat-icon>group</mat-icon>
                {{ group }}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>

          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Subgroup</mat-label>
            <mat-icon matPrefix>people</mat-icon>
            <mat-select #studentGroupSemiGroup
                        (selectionChange)="filterTimetable(studentGroup.value, studentGroupSemiGroup.value)">
              <mat-option value="SEMI_GROUP0">
                <mat-icon>exposure_zero</mat-icon>
                Subgroup 0
              </mat-option>
              <mat-option value="SEMI_GROUP1">
                <mat-icon>looks_one</mat-icon>
                Subgroup 1
              </mat-option>
              <mat-option value="SEMI_GROUP2">
                <mat-icon>looks_two</mat-icon>
                Subgroup 2
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>
      </div>

      <!-- Teacher Filter Section -->
      <div *ngIf="toggle == 'teacher'" class="filter-section">
        <div class="filter-row">
          <mat-form-field appearance="outline" class="filter-field">
            <mat-label>Teacher Name</mat-label>
            <mat-icon matPrefix>person</mat-icon>
            <div [formGroup]="teacherFormGroup">
            <input
              type="text"
              placeholder="e.g., Prof. Smith"
              #teacher
              matInput
              formControlName="teacherControl"
              [matAutocomplete]="autoTeacher"
              (focus)="selectInput($event)">
            </div>
            <mat-autocomplete #autoTeacher="matAutocomplete"
                              (optionSelected)="filterTeachers(teacher.value)">
              <mat-option *ngFor="let teacherName of filteredTeachers | async" [value]="teacherName">
                <mat-icon>account_circle</mat-icon>
                {{ teacherName }}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card class="timetable-card" elevation="2">
    <mat-card-header>
      <mat-card-title class="timetable-title">
        <mat-icon>calendar_view_week</mat-icon>
        {{ toggle === 'student' ? 'Student' : 'Teacher' }} Schedule
      </mat-card-title>
      <div class="timetable-actions">
        <!-- Quick action buttons in header -->
        <button mat-icon-button matTooltip="Refresh" (click)="refreshTimetable()">
          <mat-icon>refresh</mat-icon>
        </button>
        <button mat-icon-button matTooltip="Print" (click)="printTimetable()">
          <mat-icon>print</mat-icon>
        </button>
      </div>
    </mat-card-header>

    <mat-card-content class="timetable-content">
      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-state">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Loading timetable...</p>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isLoading && displayedTimetable.length === 0" class="empty-state">
        <mat-icon class="empty-icon">event_busy</mat-icon>
        <h3>No Schedule Found</h3>
        <p>Please select a {{ toggle === 'student' ? 'student group and subgroup' : 'teacher' }} to view the timetable.</p>
      </div>

      <!-- Timetable Container -->
      <div id="timetable" class="timetable-wrapper">
        <!-- Dynamic content will be inserted here -->
      </div>
    </mat-card-content>
  </mat-card>

  <mat-card *ngIf="isAdmin(user)" class="admin-actions-card" elevation="2">
    <mat-card-header>
      <mat-card-title class="admin-title">
        <mat-icon>admin_panel_settings</mat-icon>
        Administrative Actions
      </mat-card-title>
      <div class="edit-indicator" *ngIf="hasEditHistory()">
        <mat-icon>history</mat-icon>
        <span>{{ getEditCount() }} unsaved edit{{ getEditCount() > 1 ? 's' : '' }}</span>
      </div>
    </mat-card-header>

    <mat-card-content>
      <div class="admin-actions">
        <button mat-raised-button color="primary" class="action-button" (click)="exportTimetable()">
          <mat-icon>download</mat-icon>
          Export Timetable
        </button>

        <button mat-raised-button color="accent" class="action-button" 
                [disabled]="!hasEditHistory()" 
                (click)="undoLastEdit()">
          <mat-icon>undo</mat-icon>
          Undo Edit
        </button>

        <button mat-raised-button color="warn" class="action-button" (click)="openAnalysisDialog()">
          <mat-icon>analytics</mat-icon>
          Analyze Solution
        </button>

        <button mat-stroked-button class="action-button" 
                [disabled]="!hasEditHistory()"
                (click)="clearSessionStorage()">
          <mat-icon>clear_all</mat-icon>
          Clear Session
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Quick Stats Section -->
  <mat-card class="stats-card" elevation="1" *ngIf="isAdmin(user) && timetableData?.lessons">
    <mat-card-header>
      <mat-card-title class="stats-title">
        <mat-icon>insights</mat-icon>
        Quick Statistics
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="stats-grid">
        <div class="stat-item">
          <mat-icon class="stat-icon">class</mat-icon>
          <span class="stat-number">{{ timetableData.lessons?.length || 0 }}</span>
          <span class="stat-label">Total Lessons</span>
        </div>

        <div class="stat-item">
          <mat-icon class="stat-icon">meeting_room</mat-icon>
          <span class="stat-number">{{ timetableData.rooms?.length || 0 }}</span>
          <span class="stat-label">Rooms</span>
        </div>

        <div class="stat-item">
          <mat-icon class="stat-icon">access_time</mat-icon>
          <span class="stat-number">{{ timetableData.timeslots?.length || 0 }}</span>
          <span class="stat-label">Time Slots</span>
        </div>

        <div class="stat-item">
          <mat-icon class="stat-icon">groups</mat-icon>
          <span class="stat-number">{{ studentGroups.length || 0 }}</span>
          <span class="stat-label">Student Groups</span>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
